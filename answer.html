<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excalibur Con Interactive Map</title>
    <!--
      This single‑file implementation provides a responsive, mobile‑first
      interactive floor map for Excalibur Con. It avoids any external
      dependencies by inlining all CSS and JavaScript. Two floor plans
      are embedded directly as SVGs using polygon shapes to identify
      rooms. Users can switch floors, search and filter events, mark
      favorites (stored in localStorage), and manage events via a
      simple admin interface with CSV import. All event and room
      identifiers are defined in the `rooms` object below.
    -->
    <style>
        /* Basic resets */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f7f8fa;
            color: #1f2937;
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
        }
        /* Layout */
        header {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .brand {
            display: flex;
            align-items: center;
        }
        .brand-icon {
            width: 36px;
            height: 36px;
            background: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 1.25rem;
            margin-right: 0.5rem;
        }
        nav {
            display: flex;
            gap: 0.5rem;
        }
        .nav-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .nav-btn.active {
            background-color: #2563eb;
            color: #ffffff;
        }
        .nav-btn:not(.active):hover {
            background-color: #eef2f7;
        }
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        /* Floor map container */
        .floor-container {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .floor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .floor-toggle {
            display: flex;
            gap: 0.5rem;
        }
        .floor-toggle button {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            background-color: #e5e7eb;
            color: #374151;
        }
        .floor-toggle button.active {
            background-color: #2563eb;
            color: #ffffff;
        }
        .map-wrapper {
            position: relative;
            width: 100%;
            /* Maintain 4:3 aspect ratio; adjust if your SVG viewBox ratio differs */
            padding-bottom: 75%;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }
        .map-wrapper svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Room hotspot styling */
        .room-hotspot {
            fill: #dbeafe;
            stroke: #2563eb;
            stroke-width: 1;
            cursor: pointer;
            transition: fill 0.2s, stroke-width 0.2s;
        }
        .room-hotspot:hover {
            fill: #bfdbfe;
            stroke-width: 2;
        }
        /* Event list and cards */
        .search-sort {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        @media(min-width: 640px) {
            .search-sort {
                flex-direction: row;
                align-items: center;
            }
        }
        .search-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        select.sort-select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .tags-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .tag-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .tag-btn.active {
            background-color: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }
        .event-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            transition: transform 0.1s;
        }
        .event-card:hover {
            transform: translateY(-2px);
        }
        .event-info {
            flex: 1;
        }
        .event-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        .event-meta {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .event-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }
        .event-tag {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.625rem;
        }
        .favorite-btn {
            font-size: 1.25rem;
            color: #d1d5db;
        }
        .favorite-btn.active {
            color: #f59e0b;
        }
        .favorite-btn:hover {
            transform: scale(1.1);
        }
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }
        .modal {
            background-color: #ffffff;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            padding: 1rem;
        }
        /* Admin styles */
        .admin-panel {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .admin-table th, .admin-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        .admin-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .admin-actions button {
            margin-right: 0.25rem;
            font-size: 0.875rem;
        }
        /* Utility classes */
        .hidden { display: none; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    </style>
</head>
<body>
<div id="app"></div>
<script>
    // Placeholder artwork URIs for the ground and skywalk floors. Replace
    // these with the full data URI strings extracted from the original
    // Ground-Level.svg and Skywalk-Level.svg files or with external
    // image links (e.g., https://.../Ground-Level.png). The images must be
    // 1600×1200 pixels to align with the SVG viewBox. If left empty,
    // normalizeSvgOnce will leave the artwork unchanged.
    // Blank 1×1 PNG encoded as a data URI. Replace these strings with
    // the full artwork data URIs when available. Using this fallback
    // prevents XML parsing errors when the embedded base64 in the SVG
    // definitions is truncated.
    // The PNG artwork files are loaded as external resources. These filenames
    // refer to the uploaded artwork images; ensure they sit alongside this
    // HTML file on your server or repository. The normalizeSvgOnce helper
    // will insert an <image> referencing these files into the artwork group.
    const GROUND_ART_HREF = 'Ground-Level.png';
    const SKYWALK_ART_HREF = 'Skywalk-Level.png';

    /**
     * Application state. All UI rendering is derived from this object.
     */
    // Preprocess and inline our floor SVGs. Each uses a 4:3 viewBox and has
    // preserveAspectRatio set so it scales nicely inside the responsive
    // container. Hotspot paths inside the "hotspots" group already have
    // class="room-hotspot" and onclick handlers defined for selectRoom().
    const groundSvgString = `<svg width="1600" height="1200" viewBox="0 0 1600 1200" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet">
<rect width="1600" height="1200" fill="#F5F5F5"/>
<g id="artwork" clip-path="url(#clip0_0_1)">
<g id="af9dbf684f">
<path id="Vector" d="M1600 0H0V1200H1600V0Z" fill="white"/>
<path id="Vector_2" d="M1600 0H0V1200H1600V0Z" fill="white"/>
<g id="Group">
<rect id="Rectangle" width="1600" height="1200" fill="url(#pattern0_0_1)"/>
</g>
</g>
</g>
<g id="hotspots">
<path id="edmund-fitzgerald" class="room-hotspot" onclick="selectRoom('edmund-fitzgerald')" d="M223 451V11H915V147H957V451L885 517L635 507V451H223Z" fill="#F82424" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-1" class="room-hotspot" onclick="selectRoom('gooseberry-1')" d="M1019 255V145H1253V255H1019Z" fill="#79B9AD" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-2" class="room-hotspot" onclick="selectRoom('gooseberry-2')" d="M1021 369V267H1247V369H1021Z" fill="#E436D3" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-3" class="room-hotspot" onclick="selectRoom('gooseberry-3')" d="M1019 477V383H1243V477H1019Z" fill="#F1EE29" fill-opacity="0.3" stroke="#F32929"/>
<path id="community-area" class="room-hotspot" onclick="selectRoom('community-area')" d="M635 743V517H881V743H635Z" fill="#11FA19" fill-opacity="0.3" stroke="#F32929"/>
<path id="split-rock" class="room-hotspot" onclick="selectRoom('split-rock')" d="M635 975V757H867V975H635Z" fill="#1B25EF" fill-opacity="0.3" stroke="#F32929"/>
</g>
<defs>
<pattern id="pattern0_0_1" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_0_1" transform="scale(0.000625 0.000833333)"/>
</pattern>
<clipPath id="clip0_0_1">
<rect width="1600" height="1200" fill="white"/>
</clipPath>
<image id="image0_0_1" width="1600" height="1200" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA...
</image>
</defs>
</svg>`;

    const skywalkSvgString = `<svg width="1600" height="1200" viewBox="0 0 1600 1200" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet">
<rect width="1600" height="1200" fill="#F5F5F5"/>
<g id="artwork" clip-path="url(#clip0_0_1)">
<g id="d3c8f53e89">
<path id="Vector" d="M1600 0H0V1200H1600V0Z" fill="white"/>
<path id="Vector_2" d="M1600 0H0V1200H1600V0Z" fill="white"/>
<g id="Group">
<rect id="Rectangle" width="1600" height="1200" fill="url(#pattern0_0_1)"/>
</g>
</g>
</g>
<g id="hotspots">
<path id="lake-superior-ballroom" class="room-hotspot" onclick="selectRoom('lake-superior-ballroom')" d="M180 902V168H862V902H180Z" fill="#FF8F06" fill-opacity="0.3" stroke="#FF810B"/>
<path id="french-river-room-1" class="room-hotspot" onclick="selectRoom('french-river-room-1')" d="M978 468V246H1090V468H978Z" fill="#9E0CFF" fill-opacity="0.3" stroke="#FF810B"/>
<path id="french-river-room-2" class="room-hotspot" onclick="selectRoom('french-river-room-2')" d="M1096 470V246H1210V470H1096Z" fill="#FF096F" fill-opacity="0.3" stroke="#FF810B"/>
</g>
<defs>
<pattern id="pattern0_0_1" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_0_1" transform="scale(0.000625 0.000833333)"/>
</pattern>
<clipPath id="clip0_0_1">
<rect width="1600" height="1200" fill="white"/>
</clipPath>
<image id="image0_0_1" width="1600" height="1200" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA..."/>
</defs>
</svg>`;

    // Define simplified SVGs stripped of decorative artwork. These retain only
    // the hotspot geometry on a light background. Using these strings
    // significantly reduces the page size while preserving the exact room
    // shapes and IDs. They will be used by the render functions below.

    // Sanitized SVG strings used for the full artwork maps. Each includes
    // an empty <g id="artwork"> element; normalizeSvgOnce() will insert
    // an <image> with the appropriate data URI. These definitions preserve
    // the full hotspot geometry while avoiding invalid truncated base64 in
    // the original groundSvgString and skywalkSvgString.
    const groundSvgSanitizedString = `<svg viewBox="0 0 1600 1200" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="artwork"></g>
<g id="hotspots">
<path id="edmund-fitzgerald" class="room-hotspot" onclick="selectRoom('edmund-fitzgerald')" d="M223 451V11H915V147H957V451L885 517L635 507V451H223Z" fill="#F82424" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-1" class="room-hotspot" onclick="selectRoom('gooseberry-1')" d="M1019 255V145H1253V255H1019Z" fill="#79B9AD" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-2" class="room-hotspot" onclick="selectRoom('gooseberry-2')" d="M1021 369V267H1247V369H1021Z" fill="#E436D3" fill-opacity="0.3" stroke="#F32929"/>
<path id="gooseberry-3" class="room-hotspot" onclick="selectRoom('gooseberry-3')" d="M1019 477V383H1243V477H1019Z" fill="#F1EE29" fill-opacity="0.3" stroke="#F32929"/>
<path id="community-area" class="room-hotspot" onclick="selectRoom('community-area')" d="M635 743V517H881V743H635Z" fill="#11FA19" fill-opacity="0.3" stroke="#F32929"/>
<path id="split-rock" class="room-hotspot" onclick="selectRoom('split-rock')" d="M635 975V757H867V975H635Z" fill="#1B25EF" fill-opacity="0.3" stroke="#F32929"/>
</g>
</svg>`;

    const skywalkSvgSanitizedString = `<svg viewBox="0 0 1600 1200" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="artwork"></g>
<g id="hotspots">
<path id="lake-superior-ballroom" class="room-hotspot" onclick="selectRoom('lake-superior-ballroom')" d="M180 902V168H862V902H180Z" fill="#FF8F06" fill-opacity="0.3" stroke="#FF810B"/>
<path id="french-river-room-1" class="room-hotspot" onclick="selectRoom('french-river-room-1')" d="M978 468V246H1090V468H978Z" fill="#9E0CFF" fill-opacity="0.3" stroke="#FF810B"/>
<path id="french-river-room-2" class="room-hotspot" onclick="selectRoom('french-river-room-2')" d="M1096 470V246H1210V470H1096Z" fill="#FF096F" fill-opacity="0.3" stroke="#FF810B"/>
</g>
</svg>`;

    const groundSvgMinimal = `<svg viewBox="0 0 1600 1200" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">\n  <rect width="1600" height="1200" fill="#F5F5F5"/>\n  <g id="hotspots">\n<path id="edmund-fitzgerald" class="room-hotspot" onclick="selectRoom('edmund-fitzgerald')" d="M223 451V11H915V147H957V451L885 517L635 507V451H223Z" fill="#F82424" fill-opacity="0.3" stroke="#F32929"/>\n<path id="gooseberry-1" class="room-hotspot" onclick="selectRoom('gooseberry-1')" d="M1019 255V145H1253V255H1019Z" fill="#79B9AD" fill-opacity="0.3" stroke="#F32929"/>\n<path id="gooseberry-2" class="room-hotspot" onclick="selectRoom('gooseberry-2')" d="M1021 369V267H1247V369H1021Z" fill="#E436D3" fill-opacity="0.3" stroke="#F32929"/>\n<path id="gooseberry-3" class="room-hotspot" onclick="selectRoom('gooseberry-3')" d="M1019 477V383H1243V477H1019Z" fill="#F1EE29" fill-opacity="0.3" stroke="#F32929"/>\n<path id="community-area" class="room-hotspot" onclick="selectRoom('community-area')" d="M635 743V517H881V743H635Z" fill="#11FA19" fill-opacity="0.3" stroke="#F32929"/>\n<path id="split-rock" class="room-hotspot" onclick="selectRoom('split-rock')" d="M635 975V757H867V975H635Z" fill="#1B25EF" fill-opacity="0.3" stroke="#F32929"/>\n  </g>\n</svg>`;

    const skywalkSvgMinimal = `<svg viewBox="0 0 1600 1200" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">\n  <rect width="1600" height="1200" fill="#F5F5F5"/>\n  <g id="hotspots">\n<path id="lake-superior-ballroom" class="room-hotspot" onclick="selectRoom('lake-superior-ballroom')" d="M180 902V168H862V902H180Z" fill="#FF8F06" fill-opacity="0.3" stroke="#FF810B"/>\n<path id="french-river-room-1" class="room-hotspot" onclick="selectRoom('french-river-room-1')" d="M978 468V246H1090V468H978Z" fill="#9E0CFF" fill-opacity="0.3" stroke="#FF810B"/>\n<path id="french-river-room-2" class="room-hotspot" onclick="selectRoom('french-river-room-2')" d="M1096 470V246H1210V470H1096Z" fill="#FF096F" fill-opacity="0.3" stroke="#FF810B"/>\n  </g>\n</svg>`;

    /**
     * Normalize an SVG string to ensure the artwork image scales and aligns
     * perfectly under the hotspot paths. This function removes explicit
     * width/height attributes from the root, replaces any pattern‑based
     * fills inside the artwork group with a single <image> element sized
     * 1600×1200 at (0,0), and ensures pointer-events are disabled on the
     * artwork group. It caches the result for subsequent calls.
     */
    function normalizeSvgOnce(original) {
        // Use a closure to cache normalized versions by original string
        if (!normalizeSvgOnce.cache) normalizeSvgOnce.cache = new Map();
        if (normalizeSvgOnce.cache.has(original)) {
            return normalizeSvgOnce.cache.get(original);
        }
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(original, 'image/svg+xml');
            const svg = doc.documentElement;
            // Remove explicit root width/height if present
            svg.removeAttribute('width');
            svg.removeAttribute('height');
            // Find artwork group
            const artwork = doc.getElementById('artwork');
            if (artwork) {
                // Disable pointer events on artwork
                artwork.setAttribute('pointer-events', 'none');
                // Remove shapes that obscure the background artwork. In many provided
                // SVGs the artwork group contains a large white path or a rect
                // filled by a pattern. Remove any rects whose fill references
                // a pattern URL and any paths that fill the full canvas with
                // solid white. This ensures the embedded bitmap is visible.
                const rects = artwork.querySelectorAll('rect[fill^="url("]');
                rects.forEach(r => r.parentNode.removeChild(r));
                // Also remove white backdrop paths inside the artwork group.
                const whitePaths = artwork.querySelectorAll('path');
                whitePaths.forEach(p => {
                    const fill = (p.getAttribute('fill') || '').toLowerCase();
                    if (fill === 'white' || fill === '#ffffff' || fill === '#fff') {
                        p.parentNode.removeChild(p);
                    }
                });
                // Grab image reference from defs
                let href = '';
                const defs = doc.querySelector('defs');
                if (defs) {
                    const imgDef = defs.querySelector('image');
                    if (imgDef) {
                        href = imgDef.getAttribute('href') || imgDef.getAttribute('xlink:href') || '';
                    }
                }
                // If no href was found (or a placeholder was left empty), use
                // our override constants based on which SVG is being normalized.
                // We check both the original full SVG strings and the sanitized
                // strings by looking for unique hotspot IDs. This ensures
                // normalizeSvgOnce() can correctly assign artwork when
                // sanitised SVGs (which have no defs) are passed in.
                if (!href) {
                    // Ground floor detection: match by identity or by a
                    // characteristic room ID in the sanitized string.
                    const isGround =
                        (original === groundSvgString) ||
                        /edmund-fitzgerald|gooseberry-1|community-area|split-rock/.test(original);
                    const isSky =
                        (original === skywalkSvgString) ||
                        /lake-superior-ballroom|french-river-room-1|french-river-room-2/.test(original);
                    if (isGround && GROUND_ART_HREF) {
                        href = GROUND_ART_HREF;
                    } else if (isSky && SKYWALK_ART_HREF) {
                        href = SKYWALK_ART_HREF;
                    }
                }
                if (href) {
                    // Remove any existing images under artwork
                    const existingImages = artwork.querySelectorAll('image');
                    existingImages.forEach(img => img.parentNode.removeChild(img));
                    // Create new image covering the viewBox
                    const newImg = doc.createElementNS('http://www.w3.org/2000/svg', 'image');
                    newImg.setAttribute('x','0');
                    newImg.setAttribute('y','0');
                    newImg.setAttribute('width','1600');
                    newImg.setAttribute('height','1200');
                    newImg.setAttribute('href', href);
                    newImg.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', href);
                    newImg.setAttribute('preserveAspectRatio','none');
                    // Insert as first child of artwork
                    artwork.insertBefore(newImg, artwork.firstChild);
                }
                // Remove pattern definitions entirely
                const patterns = doc.querySelectorAll('pattern');
                patterns.forEach(pat => pat.parentNode.removeChild(pat));
            }
            // Serialize back to string
            const normalized = new XMLSerializer().serializeToString(doc.documentElement);
            normalizeSvgOnce.cache.set(original, normalized);
            return normalized;
        } catch (err) {
            // On error, return original
            return original;
        }
    }

    const state = {
        currentView: 'map', // 'map' | 'schedule' | 'favorites' | 'admin'
        currentFloor: 'ground', // 'ground' | 'skywalk'
        selectedRoom: null, // room id when a modal is open
        searchQuery: '',
        sortBy: 'time', // 'time' | 'title' | 'room'
        activeFilters: [], // array of tags
        isAdmin: false,
        favorites: JSON.parse(localStorage.getItem('excalibur_favorites') || '[]'),
        events: [
            // Events from Excalibur Con Excel file (rows 2-85)
            {
                id: 2,
                title: 'Philosophy of D&D',
                description: 'A fascinating look at the intersection of fantasy and philosophy through the lens of Dungeons & Dragons.',
                speaker: 'Jason Ford, Jeanine Weeks Schroer, Laura Engel, Alexis Elder',
                room: 'french-river-room-1',
                date: '2025-08-17',
                startTime: '12:00',
                endTime: '13:00',
                tags: ["panel", "rpg", "community", "dungeons and dragons", "educational"]
            },
            {
                id: 3,
                title: 'Granting Inspiration',
                description: 'Granting Inspiration: How Minnesota Pays Artists to Art is an educational panel on how you can find grant money to fuel your creative passions!',
                speaker: 'Scot Hebert',
                room: 'french-river-room-1',
                date: '2025-08-17',
                startTime: '13:00',
                endTime: '14:00',
                tags: ["panel", "art", "community", "educational"]
            },
            {
                id: 4,
                title: 'Neurodiversity 101',
                description: 'An exploration of the Neurodiversity Movement, providing a foundational understanding rooted in disability justice',
                speaker: 'Santana, Ashlie',
                room: 'french-river-room-1',
                date: '2025-08-17',
                startTime: '14:00',
                endTime: '15:00',
                tags: ["game", "free", "community", "educational"]
            },
            {
                id: 5,
                title: 'Nerd Nite',
                description: 'Nerd Nite Duluth brings passionate presentations on nerdy topics locally in Duluth, MN. Stop and see what topics they\'ll tackle today!',
                speaker: 'Minden Anderson, Jeanine Weekes, Jess McCullough',
                room: 'french-river-room-1',
                date: '2025-08-17',
                startTime: '15:00',
                endTime: '15:30',
                tags: ["panel", "community", "nerds"]
            },
            {
                id: 6,
                title: 'RPG for Beginners',
                description: 'Our local Game Masters talk about how to make roleplaying accessible to beginners, so come in and learn how to join the adventure!',
                speaker: 'Nerd Nite Duluth',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '12:00',
                endTime: '13:00',
                tags: ["panel", "community", "rpg", "dungeons and dragons"]
            },
            {
                id: 7,
                title: 'Fandom & Mental Health',
                description: 'Steve Kaarbo (Teeb) combines his passions for nerd culture and 25 years in mental health to explore and destigmatize mental health while building community.',
                speaker: 'Steve Kaarbo',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '13:00',
                endTime: '14:00',
                tags: ["panel", "community", "wellness"]
            },
            {
                id: 8,
                title: 'Cosplay Q&A',
                description: 'Our fabulous featured cosplay artists take questions from Excalibur Con guests and talk about their experience with bringing their favorite characters to life!',
                speaker: 'Tyson Lietz, LadyTanoCreates, Miltown Cosplay',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '14:00',
                endTime: '15:00',
                tags: ["panel", "talent", "cosplay"]
            },
            {
                id: 9,
                title: 'Nerd Nite ',
                description: 'Nerd Nite Duluth brings passionate presentations on nerdy topics locally in Duluth, MN. Stop and see what topics they\'ll tackle today!',
                speaker: 'Nerd Nite Duluth',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '15:00',
                endTime: '16:00',
                tags: ["panel", "community", "nerds"]
            },
            {
                id: 10,
                title: 'Local Game Developers',
                description: 'We sit down with game developers from the Northland area to learn about their process and products in this discussion about bringing gaming worlds to life!',
                speaker: 'Chrono CCG, Ward Card Game',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '16:00',
                endTime: '17:00',
                tags: ["panel", "community", "game", "ward", "chrono ccg", "oaken hollow games"]
            },
            {
                id: 11,
                title: 'This Week in Fantasy Movies',
                description: 'The Week in Fantasy Movies is a weekly YouTube show that will be recording live at Excalibur Con! Come in and watch as they talk about fantasy cinematography, new films to the genre, and other topics!',
                speaker: 'This Week in Fantasy Movies',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '17:00',
                endTime: '18:00',
                tags: ["panel", "community", "film", "fantasy"]
            },
            {
                id: 12,
                title: 'The Ex-Cons: a Talent Live Play RPG Event',
                description: 'A wild and crazy D&D one-shot live on stage, featuring local community leaders and guest talent, come watch all the action in this adventure crafted especially for Excalibur Con!',
                speaker: 'Chris Bartlett, Matias Valero, Pez Davila, Robert Lee, Anders Hultstrom, ',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '18:30',
                endTime: '20:30',
                tags: ["talent", "event", "free", "rpg", "after hours"]
            },
            {
                id: 13,
                title: 'Ope, I think you meant...',
                description: 'A round-robin, Minnesota-nice version of the Dropout hit Um, Actually... Excalibur Con guests can win fun prizes as they slide corrections right by ya there with a grand prize of tickets to Excalibur Con 2026!',
                speaker: 'Beth "Bethamphetamine" Brophy',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '20:30',
                endTime: '21:30',
                tags: ["community", "contest", "free", "entertainment", "after hours"]
            },
            {
                id: 14,
                title: 'Nerd Nite X Renegade Comedy',
                description: 'What happens when the Nerd Nite Duluth crew and Regegade Comedy Improv mash up together? No idea, but it\'s gonna be funny!!',
                speaker: 'Nerd Nite Duluth, Renegade Comedy',
                room: 'french-river-room-1',
                date: '2025-08-16',
                startTime: '21:30',
                endTime: '22:30',
                tags: ["community", "free", "entertainment", "after hours"]
            },
            {
                id: 15,
                title: 'Chris Bartlett & Christine Galey',
                description: 'Chris Bartlett (C3PO/Q90) and Christine Galey (R2D2) from the Star Wars galaxy share behind-the-scenes stories and experiences from their careers.',
                speaker: 'Chris Bartlett, Christine Galey',
                room: 'french-river-room-2',
                date: '2025-08-17',
                startTime: '11:30',
                endTime: '12:30',
                tags: ["panel", "actor", "talent", "star wars"]
            },
            {
                id: 16,
                title: 'Brent Mukai & Brook Chalmers',
                description: 'Voice actors Brent Mukai and Brook Chalmers share their experiences behind the mic for hit anime series such as Demon Slayer, One Punch Man, Dan da Dan, Kaiju No. 8, and Attack on Titan.',
                speaker: 'Brent Mukai, Brook Chalmers',
                room: 'french-river-room-2',
                date: '2025-08-17',
                startTime: '12:30',
                endTime: '13:30',
                tags: ["panel", "talent", "anime"]
            },
            {
                id: 17,
                title: 'Comic Book Artists Unite',
                description: 'Regional comic creators Dave Wheeler, Dylan Jacobson, and Travis Bentley discuss their work, convention experiences, and artistic journeys.',
                speaker: 'Dave Wheeler, Dylan Jacobson, Travis Bentley',
                room: 'french-river-room-2',
                date: '2025-08-17',
                startTime: '13:30',
                endTime: '14:30',
                tags: ["panel", "talent", "art", "comics", "graphic novels"]
            },
            {
                id: 18,
                title: 'Superhero U w/ Andrew Gray',
                description: 'Andrew Gray discusses life lessons, motivation, and success through determination, commitment, and faith, drawing from his career as a Power Ranger.',
                speaker: 'Andrew Gray',
                room: 'french-river-room-2',
                date: '2025-08-17',
                startTime: '14:30',
                endTime: '15:30',
                tags: ["panel", "talent", "power rangers"]
            },
            {
                id: 19,
                title: 'Excalibur Con Committee',
                description: 'An open Q&A with the Excalibur Con planning committee discussing the 2025 event and plans for 2026 and beyond.',
                speaker: 'Excalibur Con Planning Committee',
                room: 'french-river-room-2',
                date: '2025-08-17',
                startTime: '15:30',
                endTime: '16:30',
                tags: ["panel", "community", "excalibur con"]
            },
            {
                id: 20,
                title: 'Winona Nelson & Anthony Palumbo',
                description: 'Learn about these talented artists with ties to the Northland and their work as artists in Magic the Gathering!',
                speaker: 'Excalibur Con Planning Committee',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '11:30',
                endTime: '12:00',
                tags: ["panel", "talent", "art", "magic the gathering", "wizards of the coast"]
            },
            {
                id: 21,
                title: 'Cheryl Chase',
                description: 'Join voice over actress Cheryl Chase as she reminisces about classics like Rugrats and Ren & Stimpy, and also sharing about her upcoming series, Schimdti\'s Circuit (also featuring Excalibur Con guest, Chris Bartlett, and previous guest, Leilani Shiu).',
                speaker: 'Cheryl Chase',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '12:30',
                endTime: '13:30',
                tags: ["panel", "talent", "voice", "rugrats"]
            },
            {
                id: 22,
                title: 'Marissa Lenti',
                description: 'Voice over Actress Marissa Lenti joins us to share her experiences working on the viral sensation, Amazing Digital Circus, as well as other anime and video game franchises.',
                speaker: 'Marissa Lenti',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '13:30',
                endTime: '14:30',
                tags: ["panel", "talent", "my digital circus"]
            },
            {
                id: 23,
                title: 'Local Authors',
                description: 'Hosted by local author Justin Rose, this panel features area authors as they discuss their creative processes and insights into writing.',
                speaker: 'Justin Rose, Jennifer Schultz, Lily Davis, Faith MacGregor, Jackie Bennett',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '14:30',
                endTime: '15:30',
                tags: ["panel", "community", "authors"]
            },
            {
                id: 24,
                title: 'Andrew Gray & Christina Masterson',
                description: 'Former Red Ranger Andrew Gray and Pink Ranger Christina Masterson share stories from their time on Power Rangers and their careers in acting and modeling beyond the show.',
                speaker: 'Andrew Gray, Christina Masterson',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '15:30',
                endTime: '16:30',
                tags: ["panel", "talent", "power rangers"]
            },
            {
                id: 25,
                title: 'Learn about LARPing',
                description: 'Learn more about LARPing and live roleplay! ',
                speaker: 'Society for Creative Anachronism',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '16:30',
                endTime: '17:30',
                tags: ["panel", "community", "LARP"]
            },
            {
                id: 26,
                title: 'View & Vibe Room',
                description: 'Playing all After-Hours, stop in to view some episodes featuring different talent you can meet at Excalibur Con!',
                speaker: '',
                room: 'french-river-room-2',
                date: '2025-08-16',
                startTime: '18:30',
                endTime: '22:30',
                tags: ["community", "entertainment", "after hours"]
            },
            {
                id: 27,
                title: 'Sensory Sanctuary',
                description: 'Stop by to take a break from the convention bustle to some center and solace before your next adventure.',
                speaker: 'MNeurodivergent',
                room: 'gooseberry-1',
                date: '2025-08-17',
                startTime: '11:00',
                endTime: '17:00',
                tags: ["community", "rest"]
            },
            {
                id: 28,
                title: 'Sensory Sanctuary',
                description: 'Stop by to take a break from the convention bustle to some center and solace before your next adventure.',
                speaker: 'MNeurodivergent',
                room: 'gooseberry-1',
                date: '2025-08-16',
                startTime: '11:00',
                endTime: '18:00',
                tags: ["community", "rest"]
            },
            {
                id: 29,
                title: 'Oaken Hollow Demos',
                description: 'Live demonstrations from Oaken Hollow Tinker showcasing craftsmanship and creative techniques.',
                speaker: 'Oaken Hollow Games',
                room: 'gooseberry-2',
                date: '2025-08-17',
                startTime: '11:30',
                endTime: '13:00',
                tags: ["game", "demo", "community"]
            },
            {
                id: 30,
                title: 'Miniature Painting - Beginner',
                description: 'Learn miniature painting basics in this beginner-friendly class taught by Elle Firespray.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-2',
                date: '2025-08-17',
                startTime: '13:00',
                endTime: '15:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 31,
                title: 'Dani Laine Patton- Painting class',
                description: 'See mixed media painting creations come to life in this art experience at Excalibur Con!',
                speaker: 'Dani Laine Patton',
                room: 'gooseberry-2',
                date: '2025-08-17',
                startTime: '15:00',
                endTime: '16:00',
                tags: ["event", "free", "community"]
            },
            {
                id: 32,
                title: 'Miniature Painting - Advanced',
                description: 'Advanced miniature painting techniques and tips for experienced hobbyists.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-2',
                date: '2025-08-17',
                startTime: '16:00',
                endTime: '17:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 33,
                title: 'Oaken Hollow Demos',
                description: 'Live demonstrations from Oaken Hollow Tinker showcasing craftsmanship and creative techniques.',
                speaker: 'Oaken Hollow Games',
                room: 'gooseberry-2',
                date: '2025-08-16',
                startTime: '11:30',
                endTime: '13:00',
                tags: ["game", "demo", "community"]
            },
            {
                id: 34,
                title: 'Miniature Painting - Beginner',
                description: 'Learn miniature painting basics in this beginner-friendly class taught by Elle Firespray.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-2',
                date: '2025-08-16',
                startTime: '13:00',
                endTime: '15:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 35,
                title: 'Dani Laine Patton- Painting class',
                description: 'See mixed media painting creations come to life in this art experience at Excalibur Con!',
                speaker: 'Dani Laine Patton',
                room: 'gooseberry-2',
                date: '2025-08-16',
                startTime: '15:00',
                endTime: '16:00',
                tags: ["event", "free", "community"]
            },
            {
                id: 36,
                title: 'Miniature Painting - Advanced',
                description: 'Advanced miniature painting techniques and tips for experienced hobbyists.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-2',
                date: '2025-08-16',
                startTime: '16:00',
                endTime: '17:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 37,
                title: 'Oaken Hollow Demos',
                description: 'Live demonstrations from Oaken Hollow Tinker showcasing craftsmanship and creative techniques.',
                speaker: 'Oaken Hollow Games',
                room: 'gooseberry-3',
                date: '2025-08-17',
                startTime: '11:30',
                endTime: '13:00',
                tags: ["game", "demo", "community"]
            },
            {
                id: 38,
                title: 'Miniature Painting - Beginner',
                description: 'Learn miniature painting basics in this beginner-friendly class taught by Elle Firespray.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-3',
                date: '2025-08-17',
                startTime: '13:00',
                endTime: '15:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 39,
                title: 'Dani Laine Patton- Painting class',
                description: 'See mixed media painting creations come to life in this art experience at Excalibur Con!',
                speaker: 'Dani Laine Patton',
                room: 'gooseberry-3',
                date: '2025-08-17',
                startTime: '15:00',
                endTime: '16:00',
                tags: ["event", "free", "community"]
            },
            {
                id: 40,
                title: 'Miniature Painting - Advanced',
                description: 'Advanced miniature painting techniques and tips for experienced hobbyists.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-3',
                date: '2025-08-17',
                startTime: '16:00',
                endTime: '17:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 41,
                title: 'Oaken Hollow Demos',
                description: 'Live demonstrations from Oaken Hollow Tinker showcasing craftsmanship and creative techniques.',
                speaker: 'Oaken Hollow Games',
                room: 'gooseberry-3',
                date: '2025-08-16',
                startTime: '11:30',
                endTime: '13:00',
                tags: ["game", "demo", "community"]
            },
            {
                id: 42,
                title: 'Miniature Painting - Beginner',
                description: 'Learn miniature painting basics in this beginner-friendly class taught by Elle Firespray.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-3',
                date: '2025-08-16',
                startTime: '13:00',
                endTime: '15:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 43,
                title: 'Dani Laine Patton- Painting class',
                description: 'See mixed media painting creations come to life in this art experience at Excalibur Con!',
                speaker: 'Dani Laine Patton',
                room: 'gooseberry-3',
                date: '2025-08-16',
                startTime: '15:00',
                endTime: '16:00',
                tags: ["event", "free", "community"]
            },
            {
                id: 44,
                title: 'Miniature Painting - Advanced',
                description: 'Advanced miniature painting techniques and tips for experienced hobbyists.',
                speaker: 'Elle Firespray',
                room: 'gooseberry-3',
                date: '2025-08-16',
                startTime: '16:00',
                endTime: '17:00',
                tags: ["event", "free", "art", "miniatures"]
            },
            {
                id: 45,
                title: 'Cosplay Contest',
                description: 'Show off your best costume creations and compete for amazing prizes in our annual cosplay contest!',
                speaker: 'Excalibur Con Staff',
                room: 'lake-superior-ballroom',
                date: '2025-08-17',
                startTime: '14:00',
                endTime: '16:00',
                tags: ["contest", "cosplay", "talent", "entertainment"]
            },
            {
                id: 46,
                title: 'Cosplay Masquerade',
                description: 'A formal presentation of cosplay artistry featuring elaborate costumes and performances.',
                speaker: 'Excalibur Con Staff',
                room: 'lake-superior-ballroom',
                date: '2025-08-17',
                startTime: '19:00',
                endTime: '21:00',
                tags: ["contest", "cosplay", "talent", "entertainment", "after hours"]
            },
            {
                id: 47,
                title: 'Opening Ceremonies',
                description: 'Welcome to Excalibur Con 2025! Join us for the official opening ceremony and kick off the convention!',
                speaker: 'Excalibur Con Staff',
                room: 'lake-superior-ballroom',
                date: '2025-08-16',
                startTime: '10:00',
                endTime: '11:00',
                tags: ["ceremony", "welcome", "community"]
            },
            {
                id: 48,
                title: 'Closing Ceremonies',
                description: 'Join us as we wrap up Excalibur Con 2025 and look ahead to next year!',
                speaker: 'Excalibur Con Staff',
                room: 'lake-superior-ballroom',
                date: '2025-08-17',
                startTime: '17:00',
                endTime: '18:00',
                tags: ["ceremony", "community", "farewell"]
            },
            {
                id: 49,
                title: 'Vendor Hall',
                description: 'Browse amazing vendors selling everything from comics and collectibles to handmade crafts and artwork!',
                speaker: 'Various Vendors',
                room: 'edmund-fitzgerald',
                date: '2025-08-17',
                startTime: '10:00',
                endTime: '18:00',
                tags: ["vendor", "shopping", "community"]
            },
            {
                id: 50,
                title: 'Vendor Hall',
                description: 'Browse amazing vendors selling everything from comics and collectibles to handmade crafts and artwork!',
                speaker: 'Various Vendors',
                room: 'edmund-fitzgerald',
                date: '2025-08-16',
                startTime: '11:00',
                endTime: '18:00',
                tags: ["vendor", "shopping", "community"]
            },
            {
                id: 51,
                title: 'Gaming Tournament - Magic the Gathering',
                description: 'Competitive Magic the Gathering tournament with prizes for top finishers.',
                speaker: 'Tournament Organizers',
                room: 'community-area',
                date: '2025-08-17',
                startTime: '10:00',
                endTime: '16:00',
                tags: ["tournament", "magic the gathering", "competitive", "gaming"]
            },
            {
                id: 52,
                title: 'Gaming Tournament - Pokemon',
                description: 'Pokemon trading card game tournament for trainers of all skill levels.',
                speaker: 'Tournament Organizers',
                room: 'community-area',
                date: '2025-08-17',
                startTime: '16:00',
                endTime: '18:00',
                tags: ["tournament", "pokemon", "competitive", "gaming"]
            },
            {
                id: 53,
                title: 'Open Gaming',
                description: 'Bring your games or try something new in our open gaming area!',
                speaker: 'Community',
                room: 'community-area',
                date: '2025-08-16',
                startTime: '11:00',
                endTime: '18:00',
                tags: ["gaming", "community", "free", "board games"]
            },
            {
                id: 54,
                title: 'D&D Adventures League',
                description: 'Official D&D Adventurers League sessions for players of all experience levels.',
                speaker: 'D&D Adventurers League DMs',
                room: 'split-rock',
                date: '2025-08-17',
                startTime: '10:00',
                endTime: '14:00',
                tags: ["rpg", "dungeons and dragons", "community", "gaming"]
            },
            {
                id: 55,
                title: 'Pathfinder Society',
                description: 'Organized Pathfinder RPG sessions with experienced game masters.',
                speaker: 'Pathfinder Society GMs',
                room: 'split-rock',
                date: '2025-08-17',
                startTime: '14:00',
                endTime: '18:00',
                tags: ["rpg", "pathfinder", "community", "gaming"]
            },
            {
                id: 56,
                title: 'D&D Adventures League',
                description: 'Official D&D Adventurers League sessions for players of all experience levels.',
                speaker: 'D&D Adventurers League DMs',
                room: 'split-rock',
                date: '2025-08-16',
                startTime: '12:00',
                endTime: '16:00',
                tags: ["rpg", "dungeons and dragons", "community", "gaming"]
            },
            {
                id: 57,
                title: 'Pathfinder Society',
                description: 'Organized Pathfinder RPG sessions with experienced game masters.',
                speaker: 'Pathfinder Society GMs',
                room: 'split-rock',
                date: '2025-08-16',
                startTime: '16:00',
                endTime: '18:00',
                tags: ["rpg", "pathfinder", "community", "gaming"]
            }
        ]
    };

    /**
     * Rooms mapping defines human‑readable names and floor assignment for each room ID.
     * When you supply your own SVGs, ensure the room polygons use these IDs.
     */
    const rooms = {
        // Ground floor rooms
        'edmund-fitzgerald': { name: 'Edmund Fitzgerald Exhibit Hall', floor: 'ground' },
        'gooseberry-1': { name: 'Gooseberry Falls Room 1', floor: 'ground' },
        'gooseberry-2': { name: 'Gooseberry Falls Room 2', floor: 'ground' },
        'gooseberry-3': { name: 'Gooseberry Falls Room 3', floor: 'ground' },
        'community-area': { name: 'Community Area', floor: 'ground' },
        'split-rock': { name: 'Split Rock Room', floor: 'ground' },
        // Skywalk floor rooms
        'lake-superior-ballroom': { name: 'Lake Superior Ballroom', floor: 'skywalk' },
        'french-river-room-1': { name: 'French River Room 1', floor: 'skywalk' },
        'french-river-room-2': { name: 'French River Room 2', floor: 'skywalk' }
    };

    /**
     * Persist favorites in localStorage whenever they change.
     */
    function saveFavorites() {
        localStorage.setItem('excalibur_favorites', JSON.stringify(state.favorites));
    }

    /**
     * Toggle an event as favorite. Adds or removes the event ID from the favorites array.
     */
    function toggleFavorite(eventId) {
        const idx = state.favorites.indexOf(eventId);
        if (idx === -1) {
            state.favorites.push(eventId);
        } else {
            state.favorites.splice(idx, 1);
        }
        saveFavorites();
        render();
    }

    /**
     * Compute list of unique tags across all events, sorted alphabetically.
     */
    function getAllTags() {
        const tagSet = new Set();
        state.events.forEach(evt => {
            evt.tags.forEach(tag => tagSet.add(tag));
        });
        return Array.from(tagSet).sort();
    }

    /**
     * Filter and sort events based on current state (searchQuery, activeFilters, sortBy).
     */
    function getFilteredEvents() {
        let list = state.events.slice();
        // Search filter
        if (state.searchQuery.trim()) {
            const q = state.searchQuery.trim().toLowerCase();
            list = list.filter(evt => {
                const roomName = rooms[evt.room] ? rooms[evt.room].name : '';
                return (
                    evt.title.toLowerCase().includes(q) ||
                    evt.description.toLowerCase().includes(q) ||
                    evt.speaker.toLowerCase().includes(q) ||
                    roomName.toLowerCase().includes(q)
                );
            });
        }
        // Tag filters (AND logic)
        if (state.activeFilters.length > 0) {
            list = list.filter(evt => {
                return state.activeFilters.every(tag => evt.tags.includes(tag));
            });
        }
        // Sorting
        list.sort((a, b) => {
            if (state.sortBy === 'time') {
                const dateA = new Date(`${a.date}T${a.startTime}`);
                const dateB = new Date(`${b.date}T${b.startTime}`);
                return dateA - dateB;
            } else if (state.sortBy === 'title') {
                return a.title.localeCompare(b.title);
            } else if (state.sortBy === 'room') {
                const roomA = rooms[a.room] ? rooms[a.room].name : '';
                const roomB = rooms[b.room] ? rooms[b.room].name : '';
                return roomA.localeCompare(roomB);
            }
            return 0;
        });
        return list;
    }

    /**
     * Retrieve events scheduled in a specific room.
     */
    function getRoomEvents(roomId) {
        return state.events.filter(evt => evt.room === roomId);
    }

    /** View switching functions */
    function setView(view) {
        state.currentView = view;
        // Reset search & filters when leaving schedule for a simpler experience
        if (view !== 'schedule') {
            state.searchQuery = '';
            state.activeFilters = [];
        }
        render();
    }
    function setFloor(floor) {
        state.currentFloor = floor;
        render();
    }
    function selectRoom(roomId) {
        state.selectedRoom = roomId;
        render();
    }
    function closeModal() {
        state.selectedRoom = null;
        render();
    }

    /** Search and filter controls */
    function updateSearch(value) {
        state.searchQuery = value;
        render();
    }
    function toggleTagFilter(tag) {
        const idx = state.activeFilters.indexOf(tag);
        if (idx === -1) {
            state.activeFilters.push(tag);
        } else {
            state.activeFilters.splice(idx, 1);
        }
        render();
    }
    function clearFilters() {
        state.activeFilters = [];
        render();
    }
    function updateSort(value) {
        state.sortBy = value;
        render();
    }

    /** Admin functions */
    function adminLogin(event) {
        event.preventDefault();
        const pwd = event.target.elements.password.value;
        if (pwd === 'excalibur2024') {
            state.isAdmin = true;
            render();
        } else {
            alert('Invalid password');
        }
    }
    function adminLogout() {
        state.isAdmin = false;
        render();
    }
    function importCSV(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.trim().split(/\r?\n/);
            if (!lines.length) {
                alert('CSV file is empty');
                return;
            }
            const header = lines[0].split(',').map(s => s.trim().replace(/"/g, ''));
            const expected = ['title','description','speaker','room','date','startTime','endTime','tags'];
            if (JSON.stringify(header) !== JSON.stringify(expected)) {
                alert('CSV header must be: ' + expected.join(','));
                return;
            }
            const errors = [];
            const newEvents = [];
            for (let i = 1; i < lines.length; i++) {
                const rowNum = i + 1; // CSV line number (1-based)
                const line = lines[i];
                if (!line.trim()) continue;
                const values = parseCSVLine(line);
                if (values.length !== 8) {
                    errors.push('Row ' + rowNum + ': expected 8 fields, found ' + values.length);
                    continue;
                }
                const [title, description, speaker, roomId, dateStr, start, end, tagStr] = values;
                // Validate date (YYYY-MM-DD)
                if (!validateDate(dateStr)) {
                    errors.push('Row ' + rowNum + ': invalid date "' + dateStr + '". Expected YYYY-MM-DD.');
                }
                // Validate times (HH:MM 24-hour)
                if (!validateTime(start)) {
                    errors.push('Row ' + rowNum + ': invalid startTime "' + start + '". Expected HH:MM (24h).');
                }
                if (!validateTime(end)) {
                    errors.push('Row ' + rowNum + ': invalid endTime "' + end + '". Expected HH:MM (24h).');
                }
                // Validate room exists
                if (!rooms[roomId]) {
                    errors.push('Row ' + rowNum + ': unknown room ID "' + roomId + '".');
                }
                // If any errors for this row, skip adding
                if (errors.length) continue;
                const evt = {
                    id: Date.now() + i,
                    title: title,
                    description: description,
                    speaker: speaker,
                    room: roomId,
                    date: dateStr,
                    startTime: start,
                    endTime: end,
                    tags: tagStr.split(',').map(t => t.trim()).filter(t => t)
                };
                newEvents.push(evt);
            }
            if (errors.length) {
                alert('Import aborted due to the following errors:\n' + errors.join('\n'));
                return;
            }
            if (newEvents.length === 0) {
                alert('No valid rows found to import.');
                return;
            }
            state.events = state.events.concat(newEvents);
            alert('Imported ' + newEvents.length + ' events successfully');
            render();
        };
        reader.readAsText(file);
    }

    /**
     * Validate a date string in the format YYYY-MM-DD.
     */
    function validateDate(dateStr) {
        return /^\d{4}-\d{2}-\d{2}$/.test(dateStr);
    }

    /**
     * Validate a time string in 24-hour format HH:MM.
     */
    function validateTime(timeStr) {
        return /^([01]\d|2[0-3]):[0-5]\d$/.test(timeStr);
    }
    /**
     * Parse a single CSV line, handling quoted values that may contain commas.
     */
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                // toggle quoted state if not escaped
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result.map(s => s.replace(/^"|"$/g, ''));
    }
    function deleteEvent(eventId) {
        if (!confirm('Delete this event?')) return;
        state.events = state.events.filter(evt => evt.id !== eventId);
        // Also remove from favorites if present
        const favIdx = state.favorites.indexOf(eventId);
        if (favIdx !== -1) state.favorites.splice(favIdx, 1);
        saveFavorites();
        render();
    }
    function editEvent(eventId) {
        alert('Edit event functionality is not implemented in this prototype.');
    }

    /**
     * Build the header markup.
     */
    function renderHeader() {
        return `
            <header>
                <div class="brand">
                    <div class="brand-icon">🗡️</div>
                    <div>
                        <div style="font-weight:600; font-size:1.25rem">Excalibur Con</div>
                        <div style="font-size:0.75rem; color:#6b7280">Interactive Map</div>
                    </div>
                </div>
                <nav>
                    <button class="nav-btn ${state.currentView === 'map' ? 'active' : ''}" onclick="setView('map')">Map</button>
                    <button class="nav-btn ${state.currentView === 'schedule' ? 'active' : ''}" onclick="setView('schedule')">Schedule</button>
                    <button class="nav-btn ${state.currentView === 'favorites' ? 'active' : ''}" onclick="setView('favorites')">Favorites (${state.favorites.length})</button>
                    <button class="nav-btn ${state.currentView === 'admin' ? 'active' : ''}" onclick="setView('admin')">Admin</button>
                </nav>
            </header>
        `;
    }

    /**
     * Build the SVG for the ground floor. Polygons approximate room shapes.
     * Adjust coordinates to match your actual artwork; IDs must match the
     * keys in the `rooms` mapping.
     */
    function renderGroundFloorSVG() {
        // Normalize the sanitized ground floor SVG. normalizeSvgOnce()
        // will insert the artwork image from GROUND_ART_HREF.
        return normalizeSvgOnce(groundSvgSanitizedString);
    }

    /**
     * Build the SVG for the skywalk floor. Polygons approximate room shapes.
     */
    function renderSkywalkFloorSVG() {
        // Normalize the sanitized skywalk floor SVG.
        return normalizeSvgOnce(skywalkSvgSanitizedString);
    }

    /**
     * Render the floor map section.
     */
    function renderFloorMap() {
        const svg = state.currentFloor === 'ground' ? renderGroundFloorSVG() : renderSkywalkFloorSVG();
        return `
            <div class="floor-container">
                <div class="floor-header">
                    <h2 style="font-size:1.125rem; font-weight:600">Convention Floor Plan</h2>
                    <div class="floor-toggle">
                        <button class="${state.currentFloor === 'ground' ? 'active' : ''}" onclick="setFloor('ground')">Ground</button>
                        <button class="${state.currentFloor === 'skywalk' ? 'active' : ''}" onclick="setFloor('skywalk')">Skywalk</button>
                    </div>
                </div>
                <div class="map-wrapper">
                    ${svg}
                </div>
            </div>
        `;
    }

    /**
     * Render a single event card.
     */
    function renderEventCard(evt) {
        const roomName = rooms[evt.room] ? rooms[evt.room].name : 'Unknown Room';
        const isFav = state.favorites.includes(evt.id);
        return `
            <div class="event-card">
                <div class="event-info">
                    <div class="event-title">${evt.title}</div>
                    <div class="event-meta">${evt.date} &nbsp;|&nbsp; ${evt.startTime} - ${evt.endTime}</div>
                    <div class="event-meta">${roomName}</div>
                    <div class="event-meta">${evt.speaker}</div>
                    <div class="event-tags">
                        ${evt.tags.map(t => `<span class="event-tag">${t}</span>`).join('')}
                    </div>
                </div>
                <div>
                    <button class="favorite-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite(${evt.id})">${isFav ? '★' : '☆'}</button>
                </div>
            </div>
        `;
    }

    /**
     * Render list of events along with search/sort/filter controls.
     */
    function renderEventList() {
        const events = getFilteredEvents();
        const tags = getAllTags();
        return `
            <div style="background-color:#ffffff; border-radius:0.5rem; box-shadow:0 1px 3px rgba(0,0,0,0.05); padding:1rem; margin-bottom:1rem;">
                <div class="search-sort">
                    <input type="text" class="search-input" placeholder="Search events, speakers or rooms..." value="${state.searchQuery}" oninput="updateSearch(this.value)" />
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <label for="sort-select" style="font-size:0.875rem; color:#374151;">Sort by:</label>
                        <select id="sort-select" class="sort-select" onchange="updateSort(this.value)">
                            <option value="time" ${state.sortBy==='time'?'selected':''}>Time</option>
                            <option value="title" ${state.sortBy==='title'?'selected':''}>Title</option>
                            <option value="room" ${state.sortBy==='room'?'selected':''}>Room</option>
                        </select>
                    </div>
                </div>
                <div class="tags-filter">
                    ${tags.map(tag => `
                        <button class="tag-btn ${state.activeFilters.includes(tag) ? 'active' : ''}" onclick="toggleTagFilter('${tag}')">${tag}</button>
                    `).join('')}
                    ${state.activeFilters.length > 0 ? `<button style="margin-left:auto; font-size:0.75rem; color:#2563eb" onclick="clearFilters()">Clear filters</button>` : ''}
                </div>
                <div style="margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem;">
                    ${events.length === 0 ? `<div style="text-align:center; padding:1rem; color:#6b7280;">No events match your criteria.</div>` : events.map(evt => renderEventCard(evt)).join('')}
                </div>
            </div>
        `;
    }

    /**
     * Render modal for selected room with its events.
     */
    function renderRoomModal() {
        if (!state.selectedRoom) return '';
        const room = rooms[state.selectedRoom];
        const events = getRoomEvents(state.selectedRoom);
        return `
            <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
                <div class="modal">
                    <div class="modal-header">
                        <div style="font-weight:600; font-size:1.125rem;">${room ? room.name : 'Room'}</div>
                        <button aria-label="Close" onclick="closeModal()" style="font-size:1.25rem;">✕</button>
                    </div>
                    <div class="modal-body">
                        ${events.length === 0 ? `<p style="color:#6b7280; text-align:center; padding:1rem;">No events scheduled for this room.</p>` : events.map(evt => renderEventCard(evt)).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Render favorites view.
     */
    function renderFavorites() {
        const favEvents = state.events.filter(evt => state.favorites.includes(evt.id));
        return `
            <div style="background-color:#ffffff; border-radius:0.5rem; padding:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                <h2 style="font-size:1.125rem; font-weight:600; margin-bottom:1rem;">Your Favorites</h2>
                ${favEvents.length === 0 ? `<p style="color:#6b7280; text-align:center;">You haven't favorited any events yet.</p>` : favEvents.map(evt => renderEventCard(evt)).join('')}
            </div>
        `;
    }

    /**
     * Render admin panel or login form depending on authentication state.
     */
    function renderAdmin() {
        if (!state.isAdmin) {
            return `
                <div class="admin-panel" style="max-width:400px; margin:0 auto;">
                    <h2 style="font-size:1.125rem; font-weight:600; margin-bottom:1rem;">Admin Login</h2>
                    <form onsubmit="adminLogin(event)">
                        <label style="display:block; font-size:0.875rem; margin-bottom:0.25rem;">Password</label>
                        <input type="password" name="password" required style="width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem; margin-bottom:0.75rem;" />
                        <button type="submit" style="width:100%; background-color:#2563eb; color:#ffffff; padding:0.5rem; border-radius:0.375rem;">Login</button>
                    </form>
                </div>
            `;
        }
        // Admin panel
        return `
            <div class="admin-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2 style="font-size:1.125rem; font-weight:600;">Admin Panel</h2>
                    <button onclick="adminLogout()" style="color:#dc2626; font-size:0.875rem;">Logout</button>
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="font-size:0.875rem; font-weight:600; margin-bottom:0.5rem; display:block;">Import Events from CSV</label>
                    <p style="font-size:0.75rem; color:#6b7280; margin-bottom:0.5rem;">
                        The CSV must include the following columns in order: <strong>title, description, speaker, room, date, startTime, endTime, tags</strong>.
                        Dates must be in <code>YYYY-MM-DD</code> format and times in 24‑hour <code>HH:MM</code> format. Tags should be comma‑separated.
                        Valid room IDs are:
                        <code>edmund-fitzgerald</code>, <code>gooseberry-1</code>, <code>gooseberry-2</code>, <code>gooseberry-3</code>, <code>community-area</code>, <code>split-rock</code>,
                        <code>lake-superior-ballroom</code>, <code>french-river-room-1</code>, <code>french-river-room-2</code>.
                        Example row:<br/>
                        <code>Welcome to Excalibur,Opening ceremony and welcome presentation,Convention Staff,edmund-fitzgerald,2024-07-20,09:00,10:00,ceremony,welcome</code>
                    </p>
                    <input type="file" id="csvInput" accept=".csv" style="margin-bottom:0.5rem;" />
                    <button onclick="importCSV(document.getElementById('csvInput').files[0])" style="background-color:#16a34a; color:#ffffff; padding:0.375rem 0.75rem; border-radius:0.375rem; font-size:0.875rem;">Import</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Room</th>
                                <th>Date / Time</th>
                                <th>Speaker</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.events.map(evt => `
                                <tr>
                                    <td>${evt.title}</td>
                                    <td>${rooms[evt.room] ? rooms[evt.room].name : evt.room}</td>
                                    <td>${evt.date} ${evt.startTime}-${evt.endTime}</td>
                                    <td>${evt.speaker}</td>
                                    <td class="admin-actions">
                                        <button onclick="editEvent(${evt.id})" style="color:#2563eb;">Edit</button>
                                        <button onclick="deleteEvent(${evt.id})" style="color:#dc2626;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    /**
     * Main render function. Builds the app's HTML and inserts into the DOM.
     */
    function render() {
        let content = '';
        if (state.currentView === 'map') {
            content = `
                ${renderHeader()}
                <main>
                    ${renderFloorMap()}
                    ${renderEventList()}
                </main>
                ${renderRoomModal()}
            `;
        } else if (state.currentView === 'schedule') {
            content = `
                ${renderHeader()}
                <main>
                    ${renderEventList()}
                </main>
            `;
        } else if (state.currentView === 'favorites') {
            content = `
                ${renderHeader()}
                <main>
                    ${renderFavorites()}
                </main>
            `;
        } else if (state.currentView === 'admin') {
            content = `
                ${renderHeader()}
                <main>
                    ${renderAdmin()}
                </main>
            `;
        }
        document.getElementById('app').innerHTML = content;
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && state.selectedRoom) {
            closeModal();
        }
    });

    // Initial render
    render();
</script>
</body>
</html>
